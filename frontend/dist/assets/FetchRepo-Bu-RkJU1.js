import{j as C,b as A,s as R,k as M,l as P}from"./api-DNRPOSJ_.js";import{a as l,E as B}from"./index-DnFHw2Gs.js";import{m as E,a as p,Z as N,d as g,ah as y,p as i,q as b,t as v,M as w,O as d,S as h,R as f,U as r,T as V,u as x}from"./vue-DRvwLzXx.js";import"./base-CSL5GuM5.js";import"./index-DW3BOA4A.js";import"./crypto-BjADBdty.js";const j={class:"flex flex-col items-center justify-center space-y-2 p-4"},T={class:"flex flex-row items-center justify-center space-x-4"},D={key:0,class:"text-gray-500 mt-2"},F=v("br",null,null,-1),q=v("h2",{class:"text-center"},"全部鲸币申请",-1),K=E({__name:"FetchRepo",setup(O){const n=p(null);document.title="数据更新";let m=N([]);const u=async()=>{var t;try{const s=await A();m.splice(0,m.length,...s)}catch(s){const e=s;l.error("数据获取失败: "+(((t=e.response)==null?void 0:t.message)||e.message))}};g(u);const c=p(!1),_=p(!1),o=p("");g(()=>{k()});const k=async()=>{var t;try{const s=await C(),e=s==null?void 0:s.is_running;c.value=e,e?l.success("任务正在运行"):l.info("任务没有运行")}catch(s){const e=s;l.error("无法检查定时任务状态: "+(((t=e.response)==null?void 0:t.message)||e.message)),c.value=!1}},S=async()=>{var t;try{l.success("定时更新任务已启动"),c.value=!0;const s=await R();if(s.status==="success"){const e=s.message;o.value=e;let a=0;n.value=setInterval(async()=>{a++,await u(),console.log(`更新次数: ${a}`)},15e3)}else l.error("定时更新任务 数据拉取错误: "+s.message)}catch(s){const e=s;l.error("启动定时更新任务失败: "+(((t=e.response)==null?void 0:t.message)||e.message))}};setInterval(u,1*60*1e3+15e3);const U=async()=>{var t;try{await M(),n.value&&(clearInterval(n.value),n.value=null),l.success("定时更新任务已停止"),c.value=!1}catch(s){const e=s;l.error("停止定时更新任务失败: "+(((t=e.response)==null?void 0:t.message)||e.message))}},I=async()=>{var t;try{_.value=!0,o.value="正在一次性更新数据...";const s=await P();if(s.status==="success"){const e=s.message;o.value=e,await u()}else o.value="更新失败";l.success("本次手动更新完成")}catch(s){const e=s;l.error("手动更新任务失败: "+(((t=e.response)==null?void 0:t.message)||e.message)),o.value="手动更新任务失败"}finally{_.value=!1}};return(t,s)=>{const e=y("el-button"),a=y("el-table-column");return i(),b("div",j,[v("div",T,[c.value?f("",!0):(i(),w(e,{key:0,type:"success",onClick:S,class:"w-48"},{default:d(()=>[h(" 开始定时拉取 ")]),_:1})),c.value?(i(),w(e,{key:1,type:"danger",onClick:U,class:"w-48"},{default:d(()=>[h(" 停止定时拉取 ")]),_:1})):f("",!0),r(e,{type:"primary",disabled:_.value,onClick:I,class:"w-48"},{default:d(()=>[h(" 手动拉取 ")]),_:1},8,["disabled"])]),o.value?(i(),b("p",D,V(o.value),1)):f("",!0),F,q,r(x(B),{data:x(m),stripe:"","highlight-current-row":"",style:{width:"100%"}},{default:d(()=>[r(a,{prop:"user_name",label:"申请人"}),r(a,{prop:"repo",label:"仓库",width:"80"}),r(a,{prop:"role",label:"角色"}),r(a,{prop:"content",label:"内容"}),r(a,{prop:"amount",label:"数额"}),r(a,{prop:"record_time",label:"产生时间"}),r(a,{prop:"apply_status",label:"申请状态"}),r(a,{prop:"apply_time",label:"申请时间"}),r(a,{prop:"decision",label:"审批决定"})]),_:1},8,["data"])])}}});export{K as default};
